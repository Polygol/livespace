<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Livespace</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,700,1,0" />
    <script src="/assets/gurapp/api/gurasuraisu-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--background-color-tr);
            color: var(--text-color);
            width: 100vw; height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s;
            user-select: none;
        }

        /* SVG Filter */
        svg { display: none; }

        /* General UI Components */
        .icon-btn {
            background-color: transparent;
            border: none;
            color: var(--text-color);
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        .side-panel-btn {
            background-color: var(--search-background);
            border: 1px solid var(--glass-border);
            border-radius: 35px; corner-shape: superellipse(1.5);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            color: var(--text-color);
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        .material-symbols-rounded { font-size: 24px; }

        /* VIEWS */
        .view {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            transition: opacity 0.3s, transform 0.3s;
        }
        .view.hidden { opacity: 0; pointer-events: none; transform: scale(0.95); }

        /* --- HOME VIEW --- */
        #home-view { padding: 80px 20px 20px; overflow-y: auto; }
        
        .header-bar {
            position: fixed; top: 0; left: 0; right: 0;
            height: 80px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            background: linear-gradient(to bottom, var(--background-color) 0%, transparent 100%);
            z-index: 10;
        }
        .app-title { font-family: 'Open Runde', sans-serif; font-size: 1.5rem; font-weight: 700; }

        .spaces-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px; margin-top: 10px; padding-bottom: 100px;
        }

        .space-card {
            aspect-ratio: 1;
            background: var(--search-background);
            border: 1px solid var(--glass-border);
            border-radius: 35px; corner-shape: superellipse(1.5);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            display: flex; flex-direction: column;
            padding: 15px;
            cursor: pointer;
            position: relative;
        }
        .space-card h3 { font-size: 1.1rem; margin-top: auto; word-break: break-word; }
        .space-card .meta { font-size: 0.8rem; opacity: 0.6; margin-top: 5px; }
        .space-delete {
            position: absolute; top: 10px; right: 10px;
            background: transparent; border: none; color: var(--text-color); opacity: 0.5;
        }

        /* --- WORKSPACE VIEW --- */
        #workspace-view { overflow: hidden; }
        
        #canvas-container { flex: 1; position: relative; width: 100%; height: 100%; overflow: hidden; cursor: crosshair; }
        
        /* Workspace Top Bar */
        .ws-top-bar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; align-items: center;
            background: var(--search-background);
            border: 1px solid var(--glass-border);
            padding: 8px 15px;
            border-radius: 35px; corner-shape: superellipse(1.5);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            z-index: 100;
            box-shadow: var(--sun-shadow), 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .space-name { font-weight: 600; padding: 0 10px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Floating Sidebar (Pages/Layers) */
        .side-panel {
            position: absolute; top: 80px; left: 20px; bottom: 100px;
            width: 60px;
            display: flex; flex-direction: column; gap: 10px;
            pointer-events: none; z-index: 90;
        }
        .side-panel > * { pointer-events: auto; }
        
        .page-list-expanded {
            position: absolute; left: 70px; top: 0; width: 200px;
            background: var(--search-background); border: 1px solid var(--glass-border);
            border-radius: 25px; corner-shape: superellipse(1.5);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            padding: 10px;
            display: none;
            max-height: 300px; overflow-y: auto;
        }
        .page-list-expanded.show { display: block; }
        
        .page-item {
            padding: 8px 10px; border-radius: 12px; corner-shape: superellipse(1.5);
            margin-bottom: 5px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9rem;
        }
        .page-item.active { background: var(--accent); color: var(--background-color); }
        .page-item:hover:not(.active) { background: rgba(255,255,255,0.1); }

        /* Bottom toolssection */
        .toolssection {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px;
            background: var(--search-background);
            border: 1px solid var(--glass-border);
            padding: 10px 12px;
            border-radius: 35px; corner-shape: superellipse(1.5);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            z-index: 100;
            box-shadow: var(--sun-shadow), 0 5px 20px rgba(0,0,0,0.15);
        }

        /* Tool Options (Popovers) */
        .tool-options {
            position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%);
            background: var(--search-background); border: 1px solid var(--glass-border);
            padding: 10px; display: none; gap: 8px;
            border-radius: 35px; corner-shape: superellipse(1.5);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            z-index: 99; flex-wrap: wrap; max-width: 90vw; justify-content: center;
        }
        .tool-options.show { display: flex; animation: slideUp 0.2s ease; }

        /* Properties Panel (Selection) */
        .prop-panel {
            position: absolute; top: 80px; right: 20px;
            background: var(--search-background); border: 1px solid var(--glass-border);
            border-radius: 15px; padding: 10px; display: none; flex-direction: column; gap: 8px;
            backdrop-filter: blur(10px); z-index: 90; width: 50px;
        }
        .prop-panel.show { display: flex; }
        
        @keyframes slideUp { from { transform: translate(-50%, 10px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* Color inputs */
        input[type="color"] { -webkit-appearance: none; width: 28px; height: 28px; border-radius: 50%; border: none; overflow: hidden; cursor: pointer; padding: 0; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid rgba(0,0,0,0.1); border-radius: 50%; }

        .new-btn-fab {
            position: fixed; bottom: 25px; right: 25px;
            background: var(--text-color); color: var(--background-color);
            border-radius: 35px; corner-shape: superellipse(1.5);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--glass-border);
            box-shadow: var(--sun-shadow); 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 50;
        }
    </style>
</head>
<body data-app-name="LIVESPACE">

    <!-- Glass Effect SVG -->
    <svg>
        <filter id="edge-refraction-only" color-interpolation-filters="sRGB">
            <feTurbulence type="fractalNoise" baseFrequency="0.04" numOctaves="2" result="turbulence"></feTurbulence>
            <feMorphology in="SourceGraphic" operator="erode" radius="4" result="eroded"></feMorphology>
            <feComposite in="SourceGraphic" in2="eroded" operator="out" result="border_mask"></feComposite>
            <feComposite in="turbulence" in2="border_mask" operator="in" result="edge_turbulence"></feComposite>
            <feDisplacementMap in="SourceGraphic" in2="edge_turbulence" scale="15" result="disp"></feDisplacementMap>
            <feBlend in="disp" in2="SourceGraphic" mode="lighten"></feBlend>
        </filter>
    </svg>

    <!-- Home View -->
    <div id="home-view" class="view">
        <div class="header-bar">
            <div class="app-title">Livespace</div>
        </div>
        <div class="spaces-grid" id="spaces-list">
            <!-- Spaces generated here -->
        </div>
        <button class="new-btn-fab" onclick="createSpace()">
            <span class="material-symbols-rounded">add</span>
        </button>
    </div>

    <!-- Workspace View -->
    <div id="workspace-view" class="view hidden">
        <div id="canvas-container">
            <canvas id="c"></canvas>
        </div>

        <div class="ws-top-bar">
            <button class="icon-btn" onclick="exitWorkspace()" style="border-radius: 50%; width: 32px; height: 32px;">
                <span class="material-symbols-rounded" style="font-size: 20px;">arrow_back</span>
            </button>
            <div class="space-name" id="current-space-name" onclick="renameCurrentSpace()" style="cursor: pointer;">Untitled</div>
            <button class="icon-btn" onclick="saveCurrentPage()" style="border-radius: 50%; width: 32px; height: 32px;">
                <span class="material-symbols-rounded" style="font-size: 20px;">save</span>
            </button>
        </div>

        <div class="side-panel">
            <button class="side-panel-btn" id="pages-toggle">
                <span class="material-symbols-rounded">layers</span>
            </button>
            <!-- Expanded Pages List -->
            <div class="page-list-expanded" id="page-list-menu">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:600;">
                    <span>Pages</span>
                    <span class="material-symbols-rounded" onclick="addPage()" style="cursor:pointer;">add</span>
                </div>
                <div id="pages-container"></div>
            </div>
            
            <button class="side-panel-btn" onclick="resetZoom()">
                <span class="material-symbols-rounded">center_focus_strong</span>
            </button>
        </div>

        <!-- Selection Properties (Contextual) -->
        <div class="prop-panel" id="prop-panel">
            <button class="icon-btn" onclick="modifySelection('delete')" title="Delete">
                <span class="material-symbols-rounded" style="color:#ff6b6b;">cancel</span>
            </button>
            <button class="icon-btn" onclick="modifySelection('front')" title="Bring to Front">
                <span class="material-symbols-rounded">vertical_align_top</span>
            </button>
            <button class="icon-btn" onclick="modifySelection('back')" title="Send to Back">
                <span class="material-symbols-rounded">vertical_align_bottom</span>
            </button>
             <input type="color" id="prop-color" title="Change Color" onchange="modifySelection('color', this.value)">
        </div>

        <!-- toolssection Options Popovers -->
        <div class="tool-options" id="draw-options">
            <input type="color" id="draw-color" value="#ffffff">
            <input type="range" id="draw-width" min="1" max="50" value="5" style="width: 100px;">
        </div>
        
        <div class="tool-options" id="note-options">
             <div onclick="setStickyColor('#ffeb3b')" style="width:24px;height:24px;background:#ffeb3b;border-radius:50%;cursor:pointer;border:1px solid #ccc;"></div>
             <div onclick="setStickyColor('#a7ffeb')" style="width:24px;height:24px;background:#a7ffeb;border-radius:50%;cursor:pointer;border:1px solid #ccc;"></div>
             <div onclick="setStickyColor('#f8bbd0')" style="width:24px;height:24px;background:#f8bbd0;border-radius:50%;cursor:pointer;border:1px solid #ccc;"></div>
             <div onclick="setStickyColor('#212121')" style="width:24px;height:24px;background:#212121;border-radius:50%;cursor:pointer;border:1px solid #666;"></div>
        </div>

        <!-- Main toolssection -->
        <div class="toolssection">
            <button class="icon-btn active" onclick="setMode('select')" id="btn-select">
                <span class="material-symbols-rounded">pan_tool_alt</span>
            </button>
            <button class="icon-btn" onclick="setMode('draw')" id="btn-draw" oncontextmenu="toggleOptions('draw-options'); return false;">
                <span class="material-symbols-rounded">draw</span>
            </button>
             <button class="icon-btn" onclick="setMode('shape')" id="btn-shape">
                <span class="material-symbols-rounded">shapes</span>
            </button>
            <button class="icon-btn" onclick="createStickyNote()" id="btn-note" oncontextmenu="toggleOptions('note-options'); return false;">
                <span class="material-symbols-rounded">sticky_note_2</span>
            </button>
            <button class="icon-btn" onclick="addText()" id="btn-text">
                <span class="material-symbols-rounded">text_fields</span>
            </button>
            <button class="icon-btn" onclick="importImage()" id="btn-img">
                <span class="material-symbols-rounded">image</span>
            </button>
             <button class="icon-btn" onclick="toggleGrid()" id="btn-grid">
                <span class="material-symbols-rounded">grid_4x4</span>
            </button>
        </div>
    </div>

    <script>
        // --- Database Setup (Dexie) ---
        const db = new Dexie('LivespaceDB');
        db.version(1).stores({
            spaces: '++id, title, createdAt, thumbnail',
            pages: '++id, spaceId, title, order, data'
        });

        // --- Global State ---
        let currentSpaceId = null;
        let currentPageId = null;
        let canvas;
        let mode = 'select';
        let isGridEnabled = true;
        let stickyColor = '#ffeb3b';
        let currentPages = [];

        // --- Fabric Initialization ---
        function initCanvas() {
            canvas = new fabric.Canvas('c', {
                width: window.innerWidth,
                height: window.innerHeight,
                backgroundColor: 'transparent', // Using CSS pattern
                isDrawingMode: false,
                fireRightClick: true,
                stopContextMenu: true
            });
            
            // Touch Gesture Logic (Infinite Pan/Zoom)
            canvas.on('mouse:wheel', function(opt) {
                var delta = opt.e.deltaY;
                var zoom = canvas.getZoom();
                zoom *= 0.999 ** delta;
                if (zoom > 20) zoom = 20;
                if (zoom < 0.01) zoom = 0.01;
                canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
                opt.e.preventDefault();
                opt.e.stopPropagation();
                updateGrid();
            });

            // Touch Panning (Two fingers or Alt)
            let isDragging = false;
            let lastPosX, lastPosY;

            canvas.on('mouse:down', function(opt) {
                var evt = opt.e;
                if (opt.target && !isAltDown(evt)) return; // Hit object? Don't pan unless override
                
                // Allow panning if holding Alt or touch interactions on bg
                if (isAltDown(evt) || (!opt.target && !canvas.isDrawingMode)) {
                    isDragging = true;
                    canvas.selection = false;
                    lastPosX = evt.clientX || evt.touches[0].clientX;
                    lastPosY = evt.clientY || evt.touches[0].clientY;
                }
            });

            canvas.on('mouse:move', function(opt) {
                if (isDragging) {
                    var e = opt.e;
                    var clientX = e.clientX || e.touches[0].clientX;
                    var clientY = e.clientY || e.touches[0].clientY;
                    var vpt = canvas.viewportTransform;
                    vpt[4] += clientX - lastPosX;
                    vpt[5] += clientY - lastPosY;
                    canvas.requestRenderAll();
                    lastPosX = clientX;
                    lastPosY = clientY;
                    updateGrid();
                }
            });

            canvas.on('mouse:up', function() {
                canvas.setViewportTransform(canvas.viewportTransform);
                isDragging = false;
                canvas.selection = true;
            });

            canvas.on('selection:created', showProps);
            canvas.on('selection:updated', showProps);
            canvas.on('selection:cleared', hideProps);
            
            window.addEventListener('resize', () => {
                canvas.setWidth(window.innerWidth);
                canvas.setHeight(window.innerHeight);
            });

            updateGrid();
        }

        function isAltDown(evt) { return evt.altKey || (evt.touches && evt.touches.length === 2); }

        // Grid Background Logic
        function updateGrid() {
            if (!isGridEnabled) {
                document.getElementById('canvas-container').style.background = 'transparent';
                return;
            }
            // CSS Radial Gradient Dots - cheap way to simulate infinite grid
            const zoom = canvas ? canvas.getZoom() : 1;
            const size = 20 * zoom;
            const vpt = canvas ? canvas.viewportTransform : [1,0,0,1,0,0];
            const offX = vpt[4];
            const offY = vpt[5];
            
            const color = document.body.classList.contains('light-theme') ? '#ccc' : '#444';
            
            document.getElementById('canvas-container').style.backgroundSize = `${size}px ${size}px`;
            document.getElementById('canvas-container').style.backgroundPosition = `${offX}px ${offY}px`;
            document.getElementById('canvas-container').style.backgroundImage = 
                `radial-gradient(circle, ${color} 1px, transparent 1px)`;
        }

        function toggleGrid() {
            isGridEnabled = !isGridEnabled;
            updateGrid();
        }

        function resetZoom() {
            canvas.setViewportTransform([1,0,0,1,0,0]);
            updateGrid();
        }

        // --- Tools Logic ---
        function setMode(newMode) {
            mode = newMode;
            canvas.isDrawingMode = (mode === 'draw');
            
            document.querySelectorAll('.toolssection .icon-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + newMode).classList.add('active');
            
            document.querySelectorAll('.tool-options').forEach(o => o.classList.remove('show'));

            if (mode === 'draw') {
                document.getElementById('draw-options').classList.add('show');
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                updateDrawSettings();
            } else if (mode === 'note') {
                // Not a mode persay, trigger and return to select
            } else if (mode === 'shape') {
                addShape();
                setMode('select');
            }
        }

        // --- Shape Implementation ---
        function addShape() {
             // Basic implementation: Rectangle or Arrow
             const rect = new fabric.Rect({
                left: -canvas.viewportTransform[4] / canvas.getZoom() + canvas.width/2/canvas.getZoom() - 50,
                top: -canvas.viewportTransform[5] / canvas.getZoom() + canvas.height/2/canvas.getZoom() - 50,
                width: 100, height: 100, fill: 'transparent', stroke: document.body.classList.contains('light-theme')?'#000':'#fff', strokeWidth: 2
             });
             canvas.add(rect);
             canvas.setActiveObject(rect);
        }
        
        // --- Arrow/Line Logic (Custom) ---
        // Skipping complex arrow logic for brevity, implementing simple line
        // A robust "shape" menu would replace the immediate rect above.

        // --- Sticky Note Implementation ---
        function createStickyNote() {
            setMode('select');
            const center = canvas.getCenter();
            // Invert logic to place in view relative to panning
            const pan = canvas.viewportTransform;
            const x = (center.left - pan[4]) / canvas.getZoom();
            const y = (center.top - pan[5]) / canvas.getZoom();

            const group = new fabric.Group([], { left: x - 75, top: y - 75 });
            
            const rect = new fabric.Rect({
                width: 150, height: 150,
                fill: stickyColor,
                shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.2)', blur: 10, offsetX: 5, offsetY: 5 }),
                rx: 5, ry: 5
            });
            
            const text = new fabric.IText('New Note', {
                fontFamily: 'Nanum Pen Script, Inter, cursive',
                fontSize: 20,
                fill: (stickyColor === '#212121') ? '#fff' : '#333',
                left: 10, top: 10,
                width: 130,
                splitByGrapheme: true
            });
            
            group.addWithUpdate(rect);
            group.addWithUpdate(text);
            canvas.add(group);
            canvas.setActiveObject(group);
        }

        function setStickyColor(c) { stickyColor = c; createStickyNote(); }

        function addText() {
            setMode('select');
            const text = new fabric.IText('Type here', {
                left: 100, top: 100,
                fontFamily: 'Inter', fontSize: 24,
                fill: document.body.classList.contains('light-theme') ? '#000' : '#fff'
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        // --- Draw Settings ---
        document.getElementById('draw-color').addEventListener('change', updateDrawSettings);
        document.getElementById('draw-width').addEventListener('input', updateDrawSettings);
        function updateDrawSettings() {
            if(canvas.freeDrawingBrush) {
                canvas.freeDrawingBrush.color = document.getElementById('draw-color').value;
                canvas.freeDrawingBrush.width = parseInt(document.getElementById('draw-width').value, 10);
            }
        }

        function toggleOptions(id) {
            const el = document.getElementById(id);
            if(el.classList.contains('show')) el.classList.remove('show');
            else {
                 document.querySelectorAll('.tool-options').forEach(o => o.classList.remove('show'));
                 el.classList.add('show');
            }
        }

        // --- Image Import ---
        function importImage() {
            Gurasuraisu.requestFile({ accept: 'image/*', multiple: false }).then(files => {
                if (files && files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(f) {
                        fabric.Image.fromURL(f.target.result, function(img) {
                            img.scaleToWidth(200);
                            canvas.add(img);
                            canvas.setActiveObject(img);
                            canvas.renderAll();
                            saveCurrentPage(true); // Auto-save after import
                        });
                    };
                    reader.readAsDataURL(files[0]);
                }
            });
        }
        
        // --- Props Logic ---
        function showProps() {
            const active = canvas.getActiveObject();
            const panel = document.getElementById('prop-panel');
            panel.classList.add('show');
            
            const colorIn = document.getElementById('prop-color');
            if (active.fill && typeof active.fill === 'string') colorIn.value = active.fill;
        }
        function hideProps() { document.getElementById('prop-panel').classList.remove('show'); }

        function modifySelection(action, val) {
            const active = canvas.getActiveObject();
            if(!active) return;
            
            if (action === 'delete') canvas.remove(active);
            if (action === 'front') active.bringToFront();
            if (action === 'back') active.sendToBack();
            if (action === 'color') {
                if(active.type === 'i-text' || active.type === 'rect' || active.type === 'path') {
                    active.set('fill', val);
                } else if (active.type === 'group') {
                    // Primitive coloring for notes (item 0 usually rect)
                     active.getObjects()[0].set('fill', val);
                }
                canvas.requestRenderAll();
            }
        }

        // --- View Navigation & Space Management ---
        
        async function loadHome() {
            document.getElementById('workspace-view').classList.add('hidden');
            document.getElementById('home-view').classList.remove('hidden');
            const spaces = await db.spaces.toArray();
            const container = document.getElementById('spaces-list');
            container.innerHTML = '';
            spaces.forEach(space => {
                const el = document.createElement('div');
                el.className = 'space-card';
                el.onclick = (e) => { if(e.target.tagName !== 'BUTTON') openSpace(space.id, space.title); };
                el.innerHTML = `
                    <div style="flex:1; display:flex; justify-content:center; align-items:center;">
                       <span class="material-symbols-rounded" style="font-size:48px; opacity:0.3;">draw</span>
                    </div>
                    <h3>${space.title}</h3>
                    <div class="meta">${new Date(space.createdAt).toLocaleDateString()}</div>
                    <button class="space-delete" onclick="deleteSpace(${space.id}, '${space.title.replace(/'/g, "\\'")}', event)"><span class="material-symbols-rounded" style="padding: 10px; font-size: 18px;">cancel</span></button>
                `;
                container.appendChild(el);
            });
        }

        async function createSpace() {
            const id = await db.spaces.add({ title: 'New Space', createdAt: Date.now() });
            // Create default page
            await db.pages.add({ spaceId: id, title: 'Page 1', order: 0, data: {} });
            loadHome();
        }
        
        async function deleteSpace(id, title, e) {
            if (e) e.stopPropagation();
            const confirmed = await Gurasuraisu.showConfirm(`Are you sure you want to delete "${title}" and all its pages?`);
            if (confirmed) {
                await db.spaces.delete(id);
                await db.pages.where('spaceId').equals(id).delete();
                loadHome();
            }
        }
        
        async function renameCurrentSpace() {
            const space = await db.spaces.get(currentSpaceId);
            const newName = await Gurasuraisu.showPrompt("Enter new name for this space:", "Rename Space", space.title);
            if (newName && newName.trim() !== "") {
                await db.spaces.update(currentSpaceId, { title: newName.trim() });
                document.getElementById('current-space-name').innerText = newName.trim();
            }
        }        
        
        async function openSpace(id, title) {
            currentSpaceId = id;
            document.getElementById('current-space-name').innerText = title;
            document.getElementById('home-view').classList.add('hidden');
            const ws = document.getElementById('workspace-view');
            ws.classList.remove('hidden');
            
            if (!canvas) initCanvas();
            else { canvas.clear(); resetZoom(); } // Reset for new space
            
            await loadPages(id);
        }

        function exitWorkspace() {
            saveCurrentPage().then(loadHome);
        }

        // --- Page Logic ---
        async function loadPages(spaceId) {
            currentPages = await db.pages.where('spaceId').equals(spaceId).sortBy('order');
            const listEl = document.getElementById('pages-container');
            listEl.innerHTML = '';
            
            currentPages.forEach((p, index) => {
                const row = document.createElement('div');
                row.className = `page-item ${index===0 ? 'active' : ''}`; // Default to first for loading ui logic
                row.innerText = p.title;
                row.onclick = () => switchToPage(p.id);
                listEl.appendChild(row);
            });

            // Open first page
            if (currentPages.length > 0) switchToPage(currentPages[0].id);
        }

        async function addPage() {
            const title = `Page ${currentPages.length + 1}`;
            const id = await db.pages.add({
                spaceId: currentSpaceId,
                title: title,
                order: currentPages.length,
                data: {}
            });
            loadPages(currentSpaceId); // Refresh list
            switchToPage(id);
        }

        async function saveCurrentPage(silent = false) {
            if (!currentPageId || !canvas) return;
            try {
                // Use toObject() for a cleaner data structure in IndexedDB
                const data = canvas.toObject();
                await db.pages.update(currentPageId, { data: data });
                if (!silent) Gurasuraisu.showPopup('Saved');
            } catch (err) {
                console.error("Save failed:", err);
            }
        }

        async function switchToPage(pageId) {
            if (currentPageId === pageId) return;
        
            if (currentPageId) {
                // Ensure previous page is saved before switching
                const prevData = canvas.toObject();
                await db.pages.update(currentPageId, { data: prevData });
            }
            
            currentPageId = pageId;
            
            // UI Update for active state
            const items = document.getElementById('pages-container').children;
            const pageArr = await db.pages.where('spaceId').equals(currentSpaceId).sortBy('order');
            Array.from(items).forEach((c, i) => {
                if (pageArr[i].id === pageId) c.classList.add('active');
                else c.classList.remove('active');
            });
            
            const page = await db.pages.get(pageId);
            if (page && page.data && page.data.objects) {
                // Clear canvas and load new data
                canvas.clear();
                canvas.loadFromJSON(page.data, () => {
                    canvas.renderAll();
                    resetZoom();
                });
            } else {
                canvas.clear();
                resetZoom();
            }
        }

        document.getElementById('pages-toggle').addEventListener('click', () => {
             document.getElementById('page-list-menu').classList.toggle('show');
        });

        // Initialize App
        loadHome();

    </script>
</body>
</html>
